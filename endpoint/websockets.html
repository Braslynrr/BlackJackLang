<!-- websockets.html -->
<input id="username" type="text" />
<button onclick="createUser()">Create user</button>
<input id="password" type="text" />
<button onclick="createRoom()">Create room</button>
<input id="room" type="text" />
<button onclick="connectToRoom()">connect to room</button>
<pre id="output"></pre>
<script>
    var username = document.getElementById("username");
    var password = document.getElementById("password");
    var inputRoom = document.getElementById("room");
    var output = document.getElementById("output");
    var socket = undefined

    function onOpen() {
        output.innerHTML += "Status: game connected\n";
    };

    function onMessage(e) {
        let room = JSON.parse(e.data)
        output.innerHTML += "Server: room " + room.status + "\n";
    };

    function onError(e){
        output.innerHTML += `error ${e.data}`
    }


    async function createUser(){
        let bicho = await fetch("http://localhost:8080/player",{
            method: "post",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },

            //make sure to serialize your JSON body
            body: JSON.stringify({
            name: username.value,
            }) })  
        let user = await bicho.json()
        output.innerHTML+=`Welcome ${user.name}\n`
    }

    async function createRoom(){
        let bicho2 = await fetch("http://localhost:8080/room",{
            method: "post",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },

            //make sure to serialize your JSON body
            body: JSON.stringify({
            password: password.value,
            isprivate:0
            }) })  
            let room = await bicho2.json() 

            output.innerHTML+=`Room ${room.code} created\n`

            socket = new WebSocket("ws://localhost:8080/game");
            socket.onopen=onOpen
            socket.onerror=onError
            socket.onmessage=onMessage
           setTimeout(() => {
            socket.send(JSON.stringify({action:"connect",info:room}))
           }, 100);

    }

    async function connectToRoom(){

        let bicho2 = await fetch("http://localhost:8080/game",{
            method: "post",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },

            //make sure to serialize your JSON body
            body: JSON.stringify({
            code:inputRoom.value,
            password: password.value,
            }) })  
            let room = await bicho2.json() 

            output.innerHTML+=`trying to connect to room ${room.code} \n`
        socket = new WebSocket("ws://localhost:8080/game");
            socket.onopen=onOpen
            socket.onerror=onError
            socket.onmessage=onMessage
           setTimeout(() => {
            socket.send(JSON.stringify({action:"connect",info:room}))
           }, 100);
    }

</script>